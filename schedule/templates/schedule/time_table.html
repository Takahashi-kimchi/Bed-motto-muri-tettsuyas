{% extends 'base.html' %}
{% load schedule_tags %}

{% block title %}ã‚«ã‚¹ã‚¿ãƒ æ™‚é–“å‰²{% endblock %}

{% block content %}
<style>
    /* 1. ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å›ºå®šã—ã¦ãƒãƒ©ãƒ³ã‚¹ã‚’æ•´ãˆã‚‹ */
    table { 
        width: 100%; 
        border-collapse: separate; 
        border-spacing: 4px; 
        table-layout: fixed; 
    }

    th, td { border: none; padding: 12px; text-align: center; border-radius: 8px; }
    th { background-color: transparent; color: var(--text-sub); font-weight: 600; text-transform: uppercase; font-size: 0.85em; }

    /* 2. æ™‚é™åˆ—ï¼ˆå·¦ç«¯ï¼‰ï¼šå¹…ã‚’65pxã«å›ºå®š */
    .header-col-period { 
        background-color: var(--border-color); 
        color: var(--text-main); 
        font-weight: bold; 
        width: 65px; 
        padding: 8px 4px !important;
        transition: 0.3s;
        white-space: nowrap;
    }

    .time-container {
        font-size: 0.7em;
        opacity: 0.7;
        display: flex;
        flex-direction: column;
        line-height: 1.1;
        margin-top: 4px;
        font-weight: normal;
    }

    .time-separator {
        font-size: 0.8em;
        opacity: 0.4;
        margin: 1px 0;
    }

    /* 3. æˆæ¥­ã‚»ãƒ«ã®è¨­å®š */
    .class-cell { 
        background-color: var(--card-bg); 
        border: 1px solid var(--border-color); 
        transition: transform 0.2s, box-shadow 0.2s; 
        position: relative; 
        height: 125px; 
        vertical-align: top; 
        text-align: left; 
        overflow: hidden; 
    }
    .class-cell:hover { transform: translateY(-3px); box-shadow: 0 6px 12px var(--shadow); border-color: var(--accent-color); }
    
    .course-accent-bar { position: absolute; left: 0; top: 0; bottom: 0; width: 6px; z-index: 1; }
    .course-name { font-weight: bold; font-size: 0.9em; color: var(--text-main); margin-bottom: 2px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; line-height: 1.3; }
    .course-details { font-size: 0.75em; color: var(--text-sub); display: flex; align-items: center; gap: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    
    .task-area { margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border-color); }
    .progress-bar { height: 6px; background-color: var(--border-color); border-radius: 3px; overflow: hidden; margin-top: 4px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #28a745, #34ce57); border-radius: 3px; }
    .progress-text { font-size: 0.7em; font-weight: bold; color: #28a745; display: flex; justify-content: space-between; }
    
    .non-class { background-color: var(--bg-color); border: 1px dashed var(--border-color); height: 125px; opacity: 0.6; }
    .add-link { display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-sub); text-decoration: none; font-size: 1.5em; }

    .management-button { background-color: var(--accent-color); color: #ffffff; padding: 10px 18px; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 0.9em; border: none; box-shadow: 0 4px 6px var(--shadow); }
    .switch-btn { display: inline-flex; align-items: center; justify-content: center; text-decoration: none; background: var(--card-bg); padding: 8px 16px; border: 1px solid var(--border-color); border-radius: 20px; color: var(--text-main); font-size: 0.85em; font-weight: bold; min-width: 140px; transition: 0.3s; }

    @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    .status-badge { display: inline-block; color: white; font-size: 0.6em; padding: 2px 5px; border-radius: 4px; font-weight: bold; white-space: nowrap; }

    /* ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤º */
    @media (max-width: 600px) {
        .time-container { display: none; }
        th, td { padding: 8px 2px; font-size: 0.8em; }
        .header-col-period { width: 45px; }
    }

    [data-theme="dark"] .class-cell[style*="#fff1f0"] { background-color: rgba(255, 123, 114, 0.15) !important; }
    [data-theme="dark"] .class-cell[style*="#fffbe6"] { background-color: rgba(255, 166, 87, 0.15) !important; }
    [data-theme="dark"] .class-cell[style*="#e6f7ff"] { background-color: rgba(88, 166, 255, 0.15) !important; }
</style>

<div class="card" style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
    <div>
        {% if current_timetable %}
            <div style="display: flex; align-items: center; gap: 10px;">
                <h1 style="margin: 0; font-size: 1.3em;">{{ current_timetable.name }}</h1>
                {% if current_timetable.is_default %}<span style="background-color: #e6ffed; color: #28a745; border: 1px solid #28a745; font-size: 0.65em; padding: 2px 8px; border-radius: 12px; font-weight: bold;">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</span>{% endif %}
            </div>
            <select onchange="window.location.href = this.value" style="margin-top: 8px; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-color); background-color: var(--card-bg); color: var(--text-main); cursor: pointer;">
                {% for tt in user_timetables %}
                    <option value="{% url 'schedule:time_table_with_pk' timetable_pk=tt.pk %}" {% if tt.pk == current_timetable.pk %}selected{% endif %}>{{ tt.name }}</option>
                {% endfor %}
            </select>
        {% endif %}
    </div>
    <a href="{% url 'schedule:timetable_list' %}" class="management-button">âš™ï¸ è¨­å®šã‚»ãƒ³ã‚¿ãƒ¼</a>
</div>

<div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 10px; gap: 12px;">
    <span style="font-size: 0.85em; font-weight: bold;">
        {% if show_all %}<span style="color: var(--accent-color);">â— å…¨ã‚¿ã‚¹ã‚¯è¡¨ç¤ºä¸­</span>
        {% else %}<span style="color: #28a745;">â— æœªå®Œäº†ã®ã¿è¡¨ç¤ºä¸­</span>{% endif %}
    </span>
    <a href="?all={% if show_all %}0{% else %}1{% endif %}" class="switch-btn">
        {% if show_all %}æœªå®Œäº†ã®ã¿ã«ã™ã‚‹{% else %}å®Œäº†æ¸ˆã¿ã‚‚è¡¨ç¤ºã™ã‚‹{% endif %}
    </a>
</div>

<div class="card" style="padding: 10px; overflow-x: auto; background-color: var(--card-bg);">
    <table>
        <thead>
            <tr>
                <th class="header-col-period">æ™‚é™</th>
                {% for day in days %}<th>{{ day.name }}</th>{% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for period in periods %} 
                <tr>
                    <td class="header-col-period" style="text-align: center; vertical-align: middle;">
                        <div style="font-size: 0.9em;">{{ period.name }}</div>
                        <div class="time-container">
                            <span>{{ period.start_time|date:"H:i" }}</span>
                            <span class="time-separator">â†“</span>
                            <span>{{ period.end_time|date:"H:i" }}</span>
                        </div>
                    </td>
                    {% for day in days %}
                        {% with data=schedule_data|get_item:day.pk|get_item:period.pk %}
                            {% if data.schedule %}
                                <td class="class-cell" style="padding: 0;
                                    {% if data.urgency == 'overdue' %}border: 2px solid var(--color-overdue);
                                    {% elif data.urgency == 'today' %}border: 2px solid var(--color-today);
                                    {% elif data.urgency == 'weekly' %}border: 1px solid var(--color-weekly);{% endif %}">
                                    
                                    <div class="course-accent-bar" style="background-color: {{ data.schedule.course.color|default:'#e2e8f0' }};"></div>

                                    <a href="{% url 'schedule:detail' pk=data.schedule.pk %}" style="text-decoration: none; color: inherit; display: block; padding: 10px 10px 10px 16px; height: 100%; width: 100%; box-sizing: border-box; position: relative; z-index: 2;">
                                        <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 4px; min-height: 18px;">
                                            {% if data.urgency == 'overdue' %}<span class="status-badge" style="background: var(--color-overdue); animation: pulse-red 2s infinite;">âš ï¸ æœŸé™åˆ‡ã‚Œ</span>
                                            {% elif data.urgency == 'today' %}<span class="status-badge" style="background: var(--color-today);">ğŸ”” ä»Šæ—¥ã¾ã§</span>
                                            {% elif data.urgency == 'weekly' %}<span class="status-badge" style="background: var(--color-weekly);">ğŸ“… ä»Šé€±</span>{% endif %}
                                        </div>

                                        <span class="course-name" style="{% if data.urgency == 'overdue' %}color: var(--color-overdue);{% endif %}">{{ data.schedule.course.name }}</span>
                                        <div class="course-details">{% if data.schedule.course.room %}ğŸ“ {{ data.schedule.course.room }}{% else %}<span style="opacity: 0.5;">ğŸ“ -</span>{% endif %}</div>

                                        {% if data.task_count > 0 or data.completed_count > 0 %}
                                            <div class="task-area">
                                                <div class="progress-text">
                                                    <span>é€²æ—</span>
                                                    <span>{{ data.completed_count }}/{{ data.task_count }}</span>
                                                </div>
                                                <div class="progress-bar">
                                                    <div class="progress-fill" style="width: {% widthratio data.completed_count data.task_count 100 %}%; {% if data.urgency == 'overdue' %}background: var(--color-overdue);{% endif %}"></div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </a>
                                </td>
                            {% else %}
                                <td class="non-class" style="padding: 0;"><a href="{% url 'schedule:create' day_pk=day.pk period_pk=period.pk %}" class="add-link">+</a></td>
                            {% endif %}
                        {% endwith %}
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card" style="background: linear-gradient(135deg, rgba(88, 166, 255, 0.1) 0%, rgba(13, 17, 23, 0) 100%); border-left: 6px solid var(--accent-color); margin-top: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 12px;">
        <div><h2 style="font-size: 1.1em; margin: 0; color: var(--text-main);">ğŸ“Š å…¨ä½“ã®é€²æ—çŠ¶æ³</h2></div>
        <div style="text-align: right;">
            <span style="font-size: 1.6em; font-weight: bold; color: var(--accent-color); line-height: 1;">
                {% if total_timetable_tasks > 0 %}{% widthratio completed_timetable_tasks total_timetable_tasks 100 %}{% else %}0{% endif %}%
            </span>
            <div style="font-size: 0.8em; color: var(--text-sub); margin-top: 4px;">{{ completed_timetable_tasks }} / {{ total_timetable_tasks }} å®Œäº†</div>
        </div>
    </div>
    <div style="height: 12px; background-color: var(--border-color); border-radius: 6px; overflow: hidden;">
        <div style="width: {% if total_timetable_tasks > 0 %}{% widthratio completed_timetable_tasks total_timetable_tasks 100 %}{% else %}0{% endif %}%; height: 100%; background: linear-gradient(90deg, var(--accent-color), #63b3ed); transition: width 0.5s;"></div>
    </div>
</div>

<div class="card" style="margin-top: 20px;">
    <h2 style="font-size: 1.1em; margin-top: 0; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; color: var(--text-main);">âœï¸ ToDoãƒªã‚¹ãƒˆ</h2>
    {% if upcoming_todos %}
        <div style="display: grid; gap: 12px; margin-top: 15px;">
        {% for task in upcoming_todos %}
            <div style="border-left: 5px solid {% if task.is_completed %}#28a745{% elif task.urgency == 'overdue' %}var(--color-overdue){% elif task.urgency == 'today' %}var(--color-today){% elif task.urgency == 'weekly' %}var(--color-weekly){% else %}var(--accent-color){% endif %}; 
                        background: var(--bg-color); padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                <div style="flex-grow: 1;">
                    <div style="font-weight: bold; font-size: 1em; color: var(--text-main); text-decoration: {% if task.is_completed %}line-through{% else %}none{% endif %};">
                        [{{ task.course.name }}] {{ task.title }}
                        {% if not task.is_completed %}
                            {% if task.urgency == 'overdue' %}<span class="status-badge" style="background: var(--color-overdue); margin-left: 5px;">âš ï¸ æœŸé™åˆ‡ã‚Œ</span>
                            {% elif task.urgency == 'today' %}<span class="status-badge" style="background: var(--color-today); margin-left: 5px;">ğŸ”” ä»Šæ—¥ã¾ã§</span>
                            {% elif task.urgency == 'weekly' %}<span class="status-badge" style="background: var(--color-weekly); margin-left: 5px;">ğŸ“… ä»Šé€±</span>{% endif %}
                        {% else %}<span class="status-badge" style="background: #28a745; margin-left: 5px;">å®Œäº†</span>{% endif %}
                    </div>
                    <div style="font-size: 0.8em; color: var(--text-sub); margin-top: 8px;">ğŸ“… æœŸé™: {{ task.due_date|default:"æœªè¨­å®š" }}</div>
                </div>
                <div style="margin-left: 20px;">
                    <a href="{% url 'schedule:detail' pk=task.course.schedule_set.first.pk %}" class="switch-btn" style="min-width: auto; padding: 6px 12px; border-color: var(--accent-color); color: var(--accent-color);">è©³ç´° / ç·¨é›†</a>
                </div>
            </div>
        {% endfor %}
        </div>
    {% else %}
        <p style="text-align: center; color: var(--text-sub); padding: 20px;">è¡¨ç¤ºã§ãã‚‹ToDoã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    {% endif %}
</div>
{% endblock %}